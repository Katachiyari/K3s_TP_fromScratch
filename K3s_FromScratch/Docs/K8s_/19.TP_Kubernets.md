ğŸ“˜ TP Kubernetes â€” Stockage externe de A Ã  Z (On-Prem, PROD)

> ğŸ¯ Objectif final (mais PAS tout de suite)
> DÃ©ployer WordPress + DB avec stockage persistant externe, fiable et reproductible.

---

# ğŸ§  PARTIE 1 â€” Le PROBLÃˆME fondamental du stockage Kubernetes

âŒ Ce que Kubernetes NE FAIT PAS

Kubernetes :

âŒ ne fournit pas de disque

âŒ ne stocke pas les donnÃ©es

âŒ ne sauvegarde rien

ğŸ‘‰ Kubernetes oriente, attache, monte un stockage
ğŸ‘‰ Le stockage existe ailleurs

---

â“ Question clÃ© (que tout admin doit se poser)

> OÃ¹ sont physiquement stockÃ©es les donnÃ©es ?

RÃ©ponse Environnement

- Disque local du node LAB âŒ
- VM / NAS / SAN externe PROD âœ…
- Cloud provider Cloud

ğŸ‘‰ En on-prem, la rÃ©ponse correcte est :
# âœ… une machine externe (VM ou appliance)

---

# ğŸ§± PARTIE 2 â€” Architecture stockage on-prem (rÃ©alitÃ© terrain)

ğŸ—ï¸ Architecture rÃ©elle

- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
- â”‚ Application â”‚ (Pod)
- â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
- â”‚ PVC â”‚ (demande)
- â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
- â”‚ StorageClass â”‚ (type de stockage)
- â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
- â”‚ CSI Driver â”‚ (pilote)
- â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â†“
- â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
- â”‚ Stockage â”‚ (VM / NAS / SAN)
- â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# ğŸ“Œ Les donnÃ©es ne sont JAMAIS dans Kubernetes

---

# ğŸ§  PARTIE 3 â€” Les 4 couches du stockage Kubernetes (Ã  connaÃ®tre par cÅ“ur)

Couche RÃ´le Qui gÃ¨re

- Backend Disques rÃ©els Infra
- CSI Interface Kubernetes
- PV / PVC Abstraction Kubernetes
- Pod Consommation Application

---

ğŸ¢ PARTIE 4 â€” Le BACKEND de stockage (le plus important)

# ğŸ¯ En on-prem, tu as 3 choix rÃ©alistes

1ï¸âƒ£ NAS / NFS (le plus pÃ©dagogique)

VM dÃ©diÃ©e

Export NFS

Simple, lisible

TrÃ¨s courant

ğŸ‘‰ EXCELLENT pour apprendre et comprendre

---

2ï¸âƒ£ SAN (iSCSI / FC)

Plus performant

Plus complexe

Usage DB critiques

---

3ï¸âƒ£ SDS (Ceph)

Haute dispo

TrÃ¨s puissant

ComplexitÃ© Ã©levÃ©e

ğŸ‘‰ On commence TOUJOURS par NFS

---

ğŸ§ª PARTIE 5 â€” Mise en place dâ€™un stockage NFS (A â†’ Z)

ğŸ–¥ï¸ 5.1 Machine de stockage (VM dÃ©diÃ©e)

Exemple :

IP : 10.10.10.50

OS : Linux

| RÃ´le | unique : stockage |
|------|-------------------|
| Dossier | de donnÃ©es |


mkdir -p /srv/k8s-data

---

ğŸ“¡ 5.2 Export NFS

/srv/k8s-data \*(rw,sync,no_subtree_check,no_root_squash)

exportfs -rav

# ğŸ“Œ Cette VM ne connaÃ®t PAS Kubernetes

---

# ğŸ§  PARTIE 6 â€” Kubernetes ne parle PAS NFS directement

ğŸ‘‰ Kubernetes parle CSI
ğŸ‘‰ NFS est exposÃ© via un CSI Driver

ğŸ“š Doc officielle :
https://kubernetes.io/docs/concepts/storage/volumes/#nfs

---

ğŸ”Œ 6.1 CSI NFS : rÃ´le

Le CSI :

crÃ©e des dossiers

monte les volumes

les attache aux Pods

ğŸ‘‰ Sans CSI, Kubernetes ne sait rien faire

---

# ğŸ§© PARTIE 7 â€” StorageClass (la piÃ¨ce centrale)

â“ Ã€ quoi sert une StorageClass ?

> Dire Ã  Kubernetes :
> â€œQuand quelquâ€™un demande un volume, voilÃ  COMMENT le crÃ©er.â€

---

ğŸ“„ Exemple StorageClass NFS

apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
name: nfs-prod
provisioner: nfs.csi.k8s.io
parameters:
- server: 10.10.10.50
- share: /srv/k8s-data
- reclaimPolicy: Retain
- volumeBindingMode: Immediate

Analyse ligne par ligne

provisioner â†’ CSI utilisÃ©

server â†’ VM de stockage

share â†’ dossier rÃ©el

Retain â†’ les donnÃ©es survivent

Immediate â†’ crÃ©ation immÃ©diate

---

# ğŸ“Œ Appliquer

kubectl apply -f storageclass.yaml
kubectl get storageclass

---

# ğŸ§  PARTIE 8 â€” PVC : la demande de stockage

ğŸ“„ Exemple PVC

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: wordpress-pvc
namespace: wordpress
spec:
accessModes: - ReadWriteMany
resources:
requests:
storage: 5Gi
storageClassName: nfs-prod

Ce que fait Kubernetes :

# 1. Lit le PVC

2) Trouve la StorageClass

# 3. Demande au CSI

4) CrÃ©e un dossier NFS

# 5. Monte le volume

---

ğŸ” VÃ©rification

kubectl -n wordpress get pvc
kubectl get pv

ğŸ‘‰ STATUS = Bound = succÃ¨s

---

# ğŸ§  PARTIE 9 â€” Le Pod ne connaÃ®t PAS NFS

Le Pod voit juste :

/un/dossier/dans/le/conteneur

Exemple :

volumeMounts:

* mountPath: /var/www/html
  name: wordpress-data

ğŸ‘‰ Kubernetes sâ€™occupe du reste

---

# ğŸ§© PARTIE 10 â€” Pourquoi ce modÃ¨le est PROD-READY

CritÃ¨re RÃ©sultat

- Pod supprimÃ© DonnÃ©es conservÃ©es
- Pod dÃ©placÃ© DonnÃ©es remontÃ©es
- Node HS DonnÃ©es intactes
- Sauvegarde CentralisÃ©e
- ScalabilitÃ© Oui

---

# ğŸ“Œ SYNTHÃˆSE FINALE (Ã  garder)

- > Kubernetes nâ€™hÃ©berge pas les donnÃ©es
- > Kubernetes oriente les donnÃ©es
- > Le stockage vit en dehors du cluster

---

# âœ… Maintenant SEULEMENT, on est prÃªt pour :

ğŸ”¬ TP WordPress + MariaDB avec stockage externe rÃ©el

Parfait âœ…
On enchaÃ®ne immÃ©diatement avec la suite logique.

---

ğŸ”¬ TP MINIMAL â€” API + Volume

# âœ… Validation du stockage externe (A â†’ Z, PROD on-prem)

> ğŸ¯ Objectif unique de ce TP
> Prouver que :

Kubernetes crÃ©e un volume sur le stockage externe

Le Pod Ã©crit dedans

Le Pod est supprimÃ©

Les donnÃ©es persistent

ğŸ‘‰ Aucune app complexe, aucun Ingress, aucune DB
ğŸ‘‰ On valide le socle stockage, point.

---

# ğŸ§  RÃ¨gles pÃ©dagogiques du TP

1 namespace

1 PVC

1 Pod volontairement simple

1 fichier Ã©crit manuellement

1 suppression / recrÃ©ation

1 preuve physique cÃ´tÃ© NFS

---

# ğŸ§± Ã‰TAPE 0 â€” HypothÃ¨ses VALIDÃ‰ES

Tu as :

# âœ… une VM NFS fonctionnelle

# âœ… une StorageClass NFS (nfs-prod par ex)

# âœ… le CSI NFS installÃ©

# âœ… kubectl get storageclass OK

On continue.

---

# ğŸ—‚ï¸ Ã‰TAPE 1 â€” Namespace dÃ©diÃ© au test

# ğŸ“Œ Isolation + lisibilitÃ©

ğŸ“„ 00-namespace.yaml

apiVersion: v1
kind: Namespace
metadata:
name: storage-test

â–¶ï¸ Appliquer

kubectl apply -f 00-namespace.yaml
kubectl get ns

# âœ… Tu dois voir storage-test

---

ğŸ’¾ Ã‰TAPE 2 â€” PVC (la demande de stockage)

# ğŸ“Œ Ici, on dÃ©clenche rÃ©ellement la crÃ©ation du volume externe

ğŸ“„ 10-pvc.yaml

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
name: api-pvc
namespace: storage-test
spec:
accessModes: - ReadWriteMany
resources:
requests:
storage: 1Gi
storageClassName: nfs-prod

â–¶ï¸ Appliquer

kubectl apply -f 10-pvc.yaml
kubectl -n storage-test get pvc

# âœ… RÃ©sultat attendu

NAME STATUS VOLUME CAPACITY
api-pvc Bound pvc-xxxx 1Gi

# ğŸ“Œ Ã€ CE MOMENT PRÃ‰CIS, Kubernetes a :

# 1. appelÃ© le CSI

2) crÃ©Ã© un dossier sur la VM NFS

# 3. associÃ© PV â†” PVC

ğŸ‘‰ Va sur la VM NFS et regarde :

ls /srv/k8s-data

Tu dois voir un dossier auto-gÃ©nÃ©rÃ© (pvc-xxxx).

---

ğŸ§ª Ã‰TAPE 3 â€” Pod TEST (API minimale)

# ğŸ“Œ On utilise nginx uniquement pour avoir un shell et Ã©crire un fichier.

ğŸ“„ 20-pod.yaml

apiVersion: v1
kind: Pod
metadata:
name: api-test
namespace: storage-test
spec:
containers:

* name: api
  image: nginx:latest
  volumeMounts:
  * name: data
    mountPath: /data
    volumes:
* name: data
  persistentVolumeClaim:
  claimName: api-pvc

â–¶ï¸ Appliquer

kubectl apply -f 20-pod.yaml
kubectl -n storage-test get pods

Attendre :

STATUS = Running

---

âœï¸ Ã‰TAPE 4 â€” Ã‰criture de donnÃ©es (preuve nÂ°1)

Entrer dans le Pod

kubectl -n storage-test exec -it api-test -- sh

Ã‰crire un fichier

- echo "Kubernetes stockage externe OK" > /data/test.txt
- ls -l /data
- cat /data/test.txt
exit

# ğŸ“Œ Le Pod a Ã©crit dans le volume montÃ©, pas dans son FS interne.

---

ğŸ” Ã‰TAPE 5 â€” VÃ©rification PHYSIQUE (preuve nÂ°2)

ğŸ‘‰ Sur la VM NFS :

- cd /srv/k8s-data
- find . -name test.txt
- cat ./<pvc-id>/test.txt

# âœ… Si tu vois le texte â†’
# ğŸ¯ LE STOCKAGE EXTERNE EST RÃ‰EL ET FONCTIONNEL

---

ğŸ’¥ Ã‰TAPE 6 â€” Destruction du Pod (test critique)

kubectl -n storage-test delete pod api-test
kubectl -n storage-test get pods

ğŸ‘‰ Le Pod est totalement dÃ©truit

---

ğŸ” Ã‰TAPE 7 â€” RecrÃ©ation du Pod

kubectl apply -f 20-pod.yaml
kubectl -n storage-test get pods

Attendre Running.

---

ğŸ” Ã‰TAPE 8 â€” VÃ©rification aprÃ¨s recrÃ©ation (preuve finale)

kubectl -n storage-test exec -it api-test -- sh
cat /data/test.txt
exit

# âœ… RÃ©sultat attendu

Kubernetes stockage externe OK

ğŸ‰ VALIDATION COMPLÃˆTE

---

# ğŸ§  CE QUE TU VIENS DE PROUVER (IMPORTANT)

Ã‰lÃ©ment Validation

CSI OK
StorageClass OK
PVC OK
- Montage volume OK
- Persistance rÃ©elle OK
- IndÃ©pendance Pod OK
- Prod on-prem viable âœ…

---

# ğŸ“Œ NETTOYAGE (optionnel mais propre)

kubectl delete namespace storage-test

---

ğŸ”œ SUITE LOGIQUE (sans dÃ©bat)

ğŸ‘‰ TP WordPress + MariaDB avec stockage externe
Cette fois :

DB = StatefulSet + PVC

WordPress = Deployment + PVC

ConfigMap / Secret

Service / Ingress

Mais sans plus jamais douter du stockage.
